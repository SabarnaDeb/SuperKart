name: SuperKart End-to-End ML Pipeline

on:
  push:
    branches: ["main", "dev", "feature/**"]
  pull_request:
    branches: ["main"]

permissions:
  contents: write        # needed for auto-commit / auto-merge steps
  pull-requests: write   # needed for auto-merge PRs

jobs:
  ci:
    name: CI - Lint/Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run formatting (black)
        run: |
          black --check .

      - name: Run unit tests
        run: |
          pytest -q

  train_evaluate_register:
    name: Train -> Evaluate -> Register Model
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || startsWith(github.ref, 'refs/heads/feature/')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install training dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r deployment/requirements.txt
          pip install datasets huggingface_hub scikit-learn joblib pandas numpy

      - name: Train model
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_DATASET_REPO: ${{ secrets.HF_DATASET_REPO }}
        run: |
          python src/train.py

      - name: Evaluate model
        run: |
          python src/evaluate.py

      - name: Register model to Hugging Face Model Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_MODEL_REPO: ${{ secrets.HF_MODEL_REPO }}
        run: |
          python src/register_model_hf.py

  deploy_space:
    name: Deploy to Hugging Face Space
    runs-on: ubuntu-latest
    needs: [train_evaluate_register]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install deploy dependencies
        run: |
          python -m pip install --upgrade pip
          pip install huggingface_hub

      - name: Push deployment folder to HF Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_REPO: ${{ secrets.HF_SPACE_REPO }}
        run: |
          python src/deploy_space_hf.py

  auto_merge_to_main:
    name: Auto-merge PR into main (push updates to main)
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    steps:
      - name: Auto-merge PR when CI passes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            // enable auto-merge (requires repo setting: allow auto-merge)
            await github.graphql(`
              mutation($prId: ID!) {
                enablePullRequestAutoMerge(input: {pullRequestId: $prId, mergeMethod: SQUASH}) {
                  pullRequest { number, autoMergeRequest { enabledAt } }
                }
              }`,
              { prId: pr.node_id }
            );

  auto_format_commit_to_main:
    name: Auto-format and commit back to main (optional)
    runs-on: ubuntu-latest
    needs: [ci]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install black
        run: |
          python -m pip install --upgrade pip
          pip install black

      - name: Run black (apply)
        run: |
          black .

      - name: Commit changes if any
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git config user.name "github-actions"
            git config user.email "github-actions@github.com"
            git add -A
            git commit -m "chore: auto-format code"
            git push
          else
            echo "No formatting changes to commit."
          fi
